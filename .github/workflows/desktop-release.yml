name: Desktop Release (macOS + Windows)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  NODE_VERSION: "20"

jobs:
  build-win:
    name: Build Windows x64
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure cloud runtime
        shell: pwsh
        run: |
          $target = "${{ vars.AUTOZAP_TARGET_SERVER_URL }}"
          if ([string]::IsNullOrWhiteSpace($target)) {
            $target = "https://autozap-api-7hf5lkloja-uc.a.run.app"
          }
          $env:AUTOZAP_TARGET_SERVER_URL = $target
          npm run desktop:config:cloud

      - name: Build Next.js
        run: npm run build

      - name: Build Windows installers
        run: npx electron-builder --win nsis zip --x64 --publish never --config.win.signAndEditExecutable=false

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autozap-win-x64
          path: |
            dist-electron/*.exe
            dist-electron/*win*.zip
            dist-electron/latest*.yml
            dist-electron/*.blockmap
          if-no-files-found: error

  build-mac:
    name: Build macOS x64
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure cloud runtime
        run: |
          target="${{ vars.AUTOZAP_TARGET_SERVER_URL }}"
          if [ -z "$target" ]; then
            target="https://autozap-api-7hf5lkloja-uc.a.run.app"
          fi
          AUTOZAP_TARGET_SERVER_URL="$target" npm run desktop:config:cloud

      - name: Build Next.js
        run: npm run build

      - name: Prepare mac signing and notarization
        shell: bash
        env:
          CSC_LINK_SECRET: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD_SECRET: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_API_KEY_ID_SECRET: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_SECRET: ${{ secrets.APPLE_API_ISSUER }}
          APPLE_API_KEY_P8_SECRET: ${{ secrets.APPLE_API_KEY_P8 }}
        run: |
          set -e
          if [ -n "$CSC_LINK_SECRET" ] \
            && [ -n "$CSC_KEY_PASSWORD_SECRET" ] \
            && [ -n "$APPLE_API_KEY_ID_SECRET" ] \
            && [ -n "$APPLE_API_ISSUER_SECRET" ] \
            && [ -n "$APPLE_API_KEY_P8_SECRET" ]; then
            KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID_SECRET}.p8"
            printf "%s" "$APPLE_API_KEY_P8_SECRET" > "$KEY_PATH"
            chmod 600 "$KEY_PATH"

            echo "AUTOZAP_MAC_SIGNING=1" >> "$GITHUB_ENV"
            echo "CSC_LINK=$CSC_LINK_SECRET" >> "$GITHUB_ENV"
            echo "CSC_KEY_PASSWORD=$CSC_KEY_PASSWORD_SECRET" >> "$GITHUB_ENV"
            echo "APPLE_API_KEY_ID=$APPLE_API_KEY_ID_SECRET" >> "$GITHUB_ENV"
            echo "APPLE_API_ISSUER=$APPLE_API_ISSUER_SECRET" >> "$GITHUB_ENV"
            echo "APPLE_API_KEY=$KEY_PATH" >> "$GITHUB_ENV"
          else
            echo "AUTOZAP_MAC_SIGNING=0" >> "$GITHUB_ENV"
            echo "Skipping macOS signing/notarization: required secrets are missing."
          fi

      - name: Build macOS installers
        run: |
          if [ "$AUTOZAP_MAC_SIGNING" = "1" ]; then
            npx electron-builder \
              --mac dmg zip --x64 --publish never \
              --config.mac.hardenedRuntime=true \
              --config.mac.gatekeeperAssess=false \
              --config.mac.entitlements=electron/assets/entitlements.mac.plist \
              --config.mac.entitlementsInherit=electron/assets/entitlements.mac.inherit.plist
          else
            CSC_IDENTITY_AUTO_DISCOVERY=false npx electron-builder --mac dmg zip --x64 --publish never
          fi

      - name: Validate notarization
        if: env.AUTOZAP_MAC_SIGNING == '1'
        run: |
          set -e
          for dmg in dist-electron/*.dmg; do
            xcrun stapler validate "$dmg"
          done

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autozap-mac-x64
          path: |
            dist-electron/*.dmg
            dist-electron/*mac*.zip
            dist-electron/latest*.yml
            dist-electron/*.blockmap
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-win
      - build-mac
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: autozap-win-x64
          path: release-assets/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: autozap-mac-x64
          path: release-assets/macos

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/windows/*
            release-assets/macos/*
          fail_on_unmatched_files: true
          generate_release_notes: true
